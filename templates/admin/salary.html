{% extends "base.html" %}
{% block title %}Lương Của Tôi{% endblock %}

{% block sidebar %}
    <style>
        .nav-group-label { color: #adb5bd; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 1rem 1rem 0.5rem; letter-spacing: 1px; }
        .nav-link.collapsed .fas.fa-chevron-down { transform: rotate(-90deg); }
        .fas.fa-chevron-down { transition: transform 0.3s; }
        .submenu .nav-link { padding-left: 2.5rem; font-size: 0.95rem; }
    </style>

    <div class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center bg-dark text-white" data-bs-toggle="collapse" href="#menuQuanLy">
            <span><i class="fas fa-user-tie me-2 text-warning"></i>QUẢN LÝ</span><i class="fas fa-chevron-down small"></i>
        </a>
        <div class="collapse" id="menuQuanLy">
            <ul class="nav flex-column submenu bg-dark bg-opacity-50">
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="/admin/TrangChu"><i class="fas fa-tachometer-alt me-2"></i>Tổng Quan</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="#"><i class="fas fa-users me-2"></i>Nhân Sự</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="#"><i class="fas fa-calendar-alt me-2"></i>Chấm Công</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="#"><i class="fas fa-file-invoice-dollar me-2"></i>Tính Lương</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="#"><i class="fas fa-clock me-2"></i>Xếp Ca</a></li>
            </ul>
        </div>
    </div>

    <div class="nav-item mt-2">
        <a class="nav-link d-flex justify-content-between align-items-center bg-dark text-white" data-bs-toggle="collapse" href="#menuCaNhan"><span><i class="fas fa-user-circle me-2 text-info"></i>CÁ NHÂN</span><i class="fas fa-chevron-down small"></i></a>
        <div class="collapse show" id="menuCaNhan">
            <ul class="nav flex-column submenu bg-dark bg-opacity-50">
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="/admin/personal_home"><i class="fas fa-home me-2"></i> Trang Chủ</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="/admin/profile"><i class="fas fa-id-card me-2"></i> Hồ Sơ Của Tôi</a></li>
                <li class="nav-item"><a class="nav-link active text-white" href="/admin/salary"><i class="fas fa-money-check-alt me-2"></i> Bảng Lương</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="/admin/schedule"><i class="fas fa-calendar-alt me-2"></i> Lịch Làm Việc</a></li>
                <li class="nav-item"><a class="nav-link text-white-50 hover-white" href="/admin/attendlog"><i class="fas fa-history me-2"></i> Lịch Sử Chấm Công</a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <div class="row align-items-center">
            <div class="col-md-4"><h5 class="mb-0 fw-bold text-primary"><i class="fas fa-file-invoice-dollar me-2"></i>Lịch Sử Lương</h5></div>
            <div class="col-md-8">
                <div class="d-flex justify-content-end gap-2">
                    <form action="/admin/salary" method="GET" class="d-flex gap-2">
                        <select name="month" id="selectMonth" class="form-select form-select-sm w-auto" onchange="updateExportLink()"><option value="all">-- Tất cả --</option>{% for i in range(1, 13) %}<option value="{{ i }}" {% if sel_thang == i %}selected{% endif %}>Tháng {{ i }}</option>{% endfor %}</select>
                        <select name="year" id="selectYear" class="form-select form-select-sm w-auto" onchange="updateExportLink()">{% for y in range(nam_hien_tai, nam_hien_tai - 5, -1) %}<option value="{{ y }}" {% if sel_nam == y %}selected{% endif %}>Năm {{ y }}</option>{% endfor %}</select>
                        <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-filter"></i> Xem</button>
                    </form>
                    <div class="dropdown">
                        <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="fas fa-file-excel me-1"></i> Xuất Excel</button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><a class="dropdown-item" href="/admin/export_salary?type=all"><i class="fas fa-list me-2 text-secondary"></i>Xuất toàn bộ</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" id="btnExportSelected" href="#"><i class="fas fa-calendar-alt me-2 text-secondary"></i>Xuất theo tháng đang chọn</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover table-striped mb-0 align-middle"><thead class="bg-light"><tr><th class="py-3 ps-4">Kỳ Lương</th><th class="text-end">Lương Cơ Bản</th><th class="text-end text-success">Thưởng</th><th class="text-end text-danger">Phạt</th><th class="text-end fw-bold text-primary pe-4">Thực Lĩnh</th><th class="text-center">Trạng Thái</th></tr></thead><tbody>{% if bang_luong %}{% for luong in bang_luong %}<tr><td class="ps-4"><div class="fw-bold">Tháng {{ luong.Thang }}/{{ luong.Nam }}</div><small class="text-muted">{{ luong.NgayTao }}</small></td><td class="text-end">{{ "{:,.0f}".format(luong.LuongCoBan) }} ₫</td><td class="text-end text-success">{{ "{:,.0f}".format(luong.ThuongThem) }} ₫</td><td class="text-end text-danger">{{ "{:,.0f}".format(luong.Phat) }} ₫</td><td class="text-end pe-4"><span class="fw-bold fs-5 text-primary">{{ "{:,.0f}".format(luong.Tong) }} ₫</span></td><td class="text-center"><span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">{{ luong.TrangThai }}</span></td></tr>{% endfor %}{% else %}<tr><td colspan="6" class="text-center py-5 text-muted">Không có dữ liệu.</td></tr>{% endif %}</tbody></table></div></div>
</div>
<script>
    function updateExportLink() {
        var month = document.getElementById('selectMonth').value; var year = document.getElementById('selectYear').value; var exportBtn = document.getElementById('btnExportSelected');
        if (month === 'all') { exportBtn.classList.add('disabled'); exportBtn.href = "#"; } else { exportBtn.classList.remove('disabled'); exportBtn.href = "/admin/export_salary?type=filter&month=" + month + "&year=" + year; }
    }
    document.addEventListener('DOMContentLoaded', function() { updateExportLink(); });
</script>
{% endblock %}